<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>シークバー的タイムキーパー</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: rgba(0, 0, 0, 0.9);
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            user-select: none;
            overflow: hidden;
        }
        
        .timer-container {
            flex: 1;
            display: flex;
            align-items: center;
            padding: 0 15px;
            position: relative;
        }
        
        .progress-bar {
            flex: 1;
            height: 25px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            overflow: hidden;
            margin-right: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #ffff00 50%, #ff0000);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        
        .time-display {
            font-size: 18px;
            font-weight: bold;
            min-width: 90px;
            text-align: right;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }
        
        .controls {
            display: flex;
            gap: 8px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.95);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        button {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s ease;
        }
        
        button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        button:active {
            background: rgba(255, 255, 255, 0.4);
        }
        
        .close-btn {
            background: rgba(255, 0, 0, 0.7) !important;
            margin-left: auto;
        }
        
        .close-btn:hover {
            background: rgba(255, 0, 0, 0.9) !important;
        }
        
        .status {
            position: absolute;
            top: 5px;
            left: 15px;
            font-size: 10px;
            opacity: 0.7;
        }
        
        .fullscreen-note {
            position: absolute;
            bottom: 5px;
            right: 15px;
            font-size: 10px;
            opacity: 0.5;
        }
        
        @media (max-width: 500px) {
            .controls {
                flex-wrap: wrap;
            }
            button {
                font-size: 10px;
                padding: 6px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="status" id="status">待機中</div>
    <div class="fullscreen-note">F11でフルスクリーン</div>
    
    <div class="timer-container">
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="time-display" id="timeDisplay">05:00</div>
    </div>
    
    <div class="controls">
        <button id="startBtn">開始</button>
        <button id="pauseBtn">一時停止</button>
        <button id="resetBtn">リセット</button>
        <button id="setTimeBtn">時間設定</button>
        <button class="close-btn" id="closeBtn">×閉じる</button>
    </div>

    <script>
        class Timer {
            constructor() {
                this.totalSeconds = 300; // デフォルト5分
                this.currentSeconds = 0;
                this.isRunning = false;
                this.interval = null;
                
                this.progressFill = document.getElementById('progressFill');
                this.timeDisplay = document.getElementById('timeDisplay');
                this.status = document.getElementById('status');
                this.startBtn = document.getElementById('startBtn');
                this.pauseBtn = document.getElementById('pauseBtn');
                this.resetBtn = document.getElementById('resetBtn');
                this.setTimeBtn = document.getElementById('setTimeBtn');
                this.closeBtn = document.getElementById('closeBtn');
                
                this.initEventListeners();
                this.updateDisplay();
                this.loadSettings();
            }
            
            initEventListeners() {
                this.startBtn.addEventListener('click', () => this.start());
                this.pauseBtn.addEventListener('click', () => this.pause());
                this.resetBtn.addEventListener('click', () => this.reset());
                this.setTimeBtn.addEventListener('click', () => this.setTime());
                this.closeBtn.addEventListener('click', () => this.close());
                
                // キーボードショートカット
                document.addEventListener('keydown', (e) => {
                    if (e.code === 'Space') {
                        e.preventDefault();
                        this.isRunning ? this.pause() : this.start();
                    } else if (e.code === 'KeyR') {
                        e.preventDefault();
                        this.reset();
                    } else if (e.code === 'Escape') {
                        e.preventDefault();
                        this.close();
                    }
                });
                
                // ページを閉じる前の確認
                window.addEventListener('beforeunload', (e) => {
                    if (this.isRunning) {
                        e.preventDefault();
                        e.returnValue = '';
                    }
                });
            }
            
            start() {
                if (!this.isRunning) {
                    this.isRunning = true;
                    this.status.textContent = '実行中';
                    this.interval = setInterval(() => {
                        this.currentSeconds++;
                        this.updateDisplay();
                        
                        if (this.currentSeconds >= this.totalSeconds) {
                            this.pause();
                            this.status.textContent = '時間終了！';
                            this.showAlert('時間終了！');
                        }
                    }, 1000);
                }
            }
            
            pause() {
                this.isRunning = false;
                this.status.textContent = '一時停止';
                if (this.interval) {
                    clearInterval(this.interval);
                    this.interval = null;
                }
            }
            
            reset() {
                this.pause();
                this.currentSeconds = 0;
                this.status.textContent = '待機中';
                this.updateDisplay();
            }
            
            setTime() {
                const minutes = prompt('タイマー時間を分で入力してください:', Math.floor(this.totalSeconds / 60));
                if (minutes !== null && !isNaN(minutes) && minutes > 0) {
                    this.totalSeconds = parseInt(minutes) * 60;
                    this.saveSettings();
                    this.reset();
                }
            }
            
            updateDisplay() {
                const progress = Math.min((this.currentSeconds / this.totalSeconds) * 100, 100);
                this.progressFill.style.width = `${progress}%`;
                
                const remainingSeconds = Math.max(0, this.totalSeconds - this.currentSeconds);
                const minutes = Math.floor(remainingSeconds / 60);
                const seconds = remainingSeconds % 60;
                this.timeDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // ページタイトルも更新
                document.title = `${this.timeDisplay.textContent} - シークバー的タイムキーパー`;
            }
            
            showAlert(message) {
                // 視覚的なアラート
                document.body.style.background = 'rgba(255, 0, 0, 0.8)';
                setTimeout(() => {
                    document.body.style.background = 'rgba(0, 0, 0, 0.9)';
                }, 500);
                
                // 音声アラート（ビープ音）
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 1);
                } catch (e) {
                    console.log('音声アラートをサポートしていません');
                }
                
                alert(message);
            }
            
            saveSettings() {
                localStorage.setItem('timerSettings', JSON.stringify({
                    totalSeconds: this.totalSeconds
                }));
            }
            
            loadSettings() {
                try {
                    const settings = JSON.parse(localStorage.getItem('timerSettings'));
                    if (settings && settings.totalSeconds) {
                        this.totalSeconds = settings.totalSeconds;
                        this.updateDisplay();
                    }
                } catch (e) {
                    // 設定の読み込みに失敗した場合は無視
                }
            }
            
            close() {
                if (this.isRunning) {
                    if (confirm('タイマーが実行中です。本当に終了しますか？')) {
                        window.close();
                    }
                } else {
                    window.close();
                }
            }
        }

        // ページ読み込み完了後にタイマーを初期化
        document.addEventListener('DOMContentLoaded', () => {
            new Timer();
        });
        
        // フルスクリーン対応
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F11') {
                e.preventDefault();
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            }
        });
    </script>
</body>
</html>